steps:
- label: build
  command:
  - nix3 build

- label: cache
  if: build.branch == "main"
  command:
  - echo +++
  - nix3 build
  - cachix push alejandra result

  - nix3 develop --profile develop --command true
  - cachix push alejandra develop

- label: coverage
  if: build.branch == "main"
  command:
  - echo +++
  - direnv allow
  - eval "$(direnv export bash)"
  - cargo tarpaulin --coveralls "${COVERALLS_REPO_TOKEN}"

- label: diff
  if: build.branch != "main"
  command:
  - git clone --depth 1 https://github.com/nixos/nixpkgs
  - echo --- Closure @ before
  - nix-env --query --available --attr-path --drv-path --file nixpkgs --xml > before

  - echo --- Formatting
  - nix3 run . -- nixpkgs

  - echo --- Closure @ after
  - nix-env --query --available --attr-path --drv-path --file nixpkgs --xml > after

  - echo +++ Closure diff
  - git diff --no-index before after || true
  - git diff --no-index before after --shortstat || true
  - echo +++ Derivations
  - grep -c drvPath= after

- label: flake check
  command:
  - echo +++
  - nix3 flake check
